<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room Booking Scheduler</title>
    <link
      rel="stylesheet"
      href="./daypilot-pro/daypilot-pro/demo/themes/scheduler_white.css"
    />
  </head>
  <body class="bg-gray-100">
    <header
      class="bg-gray-800 text-white px-8 py-4 flex justify-between items-center shadow"
    >
      <div class="text-xl font-semibold">üìÖ Room Booking Scheduler</div>
      <nav class="flex gap-6">
        <a href="#" class="hover:underline">Trang ch·ªß</a>
        <a href="#" class="hover:underline">Ph√≤ng</a>
        <a href="#" class="hover:underline">Kh√°ch h√†ng</a>
        <a href="#" class="hover:underline">B√°o c√°o</a>
        <a href="#" class="hover:underline">C√†i ƒë·∫∑t</a>
      </nav>
    </header>
    <main class="max-w-6xl mx-auto bg-white p-6 mt-6 rounded-lg shadow">
      <div
        id="toolbar"
        class="flex flex-wrap justify-end items-center gap-3 mb-4"
      >
        <label for="datePicker" class="font-medium">Ch·ªçn ng√†y:</label>
        <input type="date" id="datePicker" class="border rounded px-3 py-1" />
        <label for="viewMode" class="font-medium">Xem:</label>
        <select id="viewMode" class="border rounded px-3 py-1">
          <option value="day">Ng√†y</option>
          <option value="week">Tu·∫ßn</option>
          <option value="month" selected>Th√°ng</option>
        </select>
      </div>
      <div id="dp"></div>
    </main>

    <div
      id="bookingModal"
      class="hidden fixed top-10 left-1/2 transform -translate-x-1/2 w-full max-w-6xl bg-white p-6 border border-gray-300 rounded-lg shadow-lg z-50"
    >
      <form id="bookingForm" class="space-y-3">
        <h3 class="text-lg font-semibold mb-2">ƒê·∫∑t ph√≤ng</h3>
        <!-- S·ªë ph√≤ng -->
        <label class="block"
          >S·ªë ph√≤ng <span class="text-red-500">*</span>
          <input
            name="room"
            readonly
            class="mt-1 border rounded px-3 py-1 w-full"
          />
        </label>

        <!-- Lo·∫°i ph√≤ng -->
        <label class="block"
          >Lo·∫°i ph√≤ng <span class="text-red-500">*</span>
          <select
            name="type"
            required
            id="roomTypeSelect"
            class="mt-1 border rounded px-3 py-1 w-full"
          >
            <option value="">-- Ch·ªçn lo·∫°i ph√≤ng --</option>
            <!-- C√°c option s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
          </select>
        </label>

        <!-- T·ª´ ng√†y -->
        <label class="block"
          >T·ª´ ng√†y <span class="text-red-500">*</span>
          <input
            name="start"
            required
            class="mt-1 border rounded px-3 py-1 w-full"
          />
        </label>

        <!-- ƒê·∫øn ng√†y -->
        <label class="block"
          >ƒê·∫øn ng√†y <span class="text-red-500">*</span>
          <input
            name="end"
            required
            class="mt-1 border rounded px-3 py-1 w-full"
          />
        </label>

        <!-- S·ªë l∆∞·ª£ng kh√°ch -->
        <label class="block"
          >S·ªë l∆∞·ª£ng kh√°ch <span class="text-red-500">*</span>
          <input
            name="guests"
            type="number"
            required
            class="mt-1 border rounded px-3 py-1 w-full"
          />
        </label>

        <!-- H·ªç t√™n -->
        <label class="block"
          >H·ªç & t√™n <span class="text-red-500">*</span>
          <input
            name="name"
            required
            class="mt-1 border rounded px-3 py-1 w-full"
          />
        </label>

        <!-- SƒêT -->
        <label class="block"
          >S·ªë ƒëi·ªán tho·∫°i <span class="text-red-500">*</span>
          <input
            name="phone"
            required
            maxlength="10"
            pattern="^0\d{9}$"
            class="mt-1 border rounded px-3 py-1 w-full"
          />
        </label>

        <!-- Email -->
        <label class="block"
          >Email
          <input name="email" class="mt-1 border rounded px-3 py-1 w-full" />
        </label>
        <label class="block"
          >Ghi ch√∫
          <textarea
            name="note"
            class="mt-1 border rounded px-3 py-1 w-full"
          ></textarea>
        </label>
        <div class="flex justify-end gap-3">
          <button
            type="submit"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          >
            L∆∞u
          </button>
          <button
            type="button"
            onclick="closeModal()"
            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
          >
            H·ªßy
          </button>
        </div>
      </form>
    </div>
    <div
      id="alertBox"
      class="hidden fixed top-4 right-4 px-4 py-2 rounded shadow text-white text-sm z-[9999]"
    ></div>
    <script src="./daypilot-pro/daypilot-pro/scripts/daypilot-all.min.js"></script>
    <script>
      const rooms = [
        { name: "Ph√≤ng 101", id: "R1", type: "Standard" },
        { name: "Ph√≤ng 102", id: "R2", type: "Deluxe" },
        { name: "Ph√≤ng 201", id: "R3", type: "VIP" },
      ];

      const events = [];
      const today = DayPilot.Date.today();

      events.push(
        {
          id: "1",
          text: "Nguy·ªÖn VƒÉn A (2 kh√°ch)",
          start: today.addHours(1),
          end: today.addHours(4),
          resource: "R1",
          name: "Nguy·ªÖn VƒÉn A",
          guests: 2,
          phone: "0909123456",
          email: "a@example.com",
          note: "",
          type: "Standard",
        },
        {
          id: "2",
          text: "Tr·∫ßn Th·ªã B (3 kh√°ch)",
          start: today.addHours(5),
          end: today.addHours(8),
          resource: "R2",
          name: "Tr·∫ßn Th·ªã B",
          guests: 3,
          phone: "0909234567",
          email: "b@example.com",
          note: "",
          type: "Deluxe",
        },
        {
          id: "3",
          text: "L√™ VƒÉn C (1 kh√°ch)",
          start: today.addHours(10),
          end: today.addHours(12),
          resource: "R3",
          name: "L√™ VƒÉn C",
          guests: 1,
          phone: "0909345678",
          email: "c@example.com",
          note: "",
          type: "VIP",
        }
      );
      const dp = new DayPilot.Scheduler("dp", {
        timeHeaders: [
          { groupBy: "Day", format: "dd/MM/yyyy" },
          { groupBy: "Hour" },
        ],
        scale: "Hour",
        days: 30,
        startDate: DayPilot.Date.today(),
        businessBeginsHour: 6,
        businessEndsHour: 20,
        cellWidth: 40,
        wheelStep: 24,
        scrollX: "Auto",
        scrollY: "Auto",
        wheelHorizontal: true,
        resources: rooms,
        events: events,
        theme: "scheduler_white",
        contextMenu: new DayPilot.Menu({
          items: [
            {
              text: "Xo√° ƒë·∫∑t ph√≤ng",
              onClick: function (args) {
                if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° l·ªãch ƒë·∫∑t ph√≤ng n√†y?")) {
                  dp.events.remove(args.source);
                  showAlert("ƒê√£ x√≥a s·ª± ki·ªán th√†nh c√¥ng", "bg-red-500");
                  showAlert("‚ùå ƒê√£ xo√° s·ª± ki·ªán th√†nh c√¥ng", "bg-red-500");
                }
              },
            },
          ],
        }),
        onTimeRangeSelected: function (args) {
          // T·∫°o object m√¥ ph·ªèng event m·ªõi
          const newEvent = {
            id: "", // id r·ªóng v√¨ l√† m·ªõi
            resource: args.resource,
            start: args.start,
            end: args.end,
          };

          // Ki·ªÉm tra tr√πng
          if (isOverlapping(newEvent)) {
            showAlert(
              "‚ö†Ô∏è Kho·∫£ng th·ªùi gian ƒë√£ c√≥ ng∆∞·ªùi ƒë·∫∑t ph√≤ng n√†y!",
              "bg-red-600"
            );
            dp.clearSelection();
            return;
          }

          openModal(args);
          dp.clearSelection();
        },
        onEventResized: function (args) {
          const originalStart = new DayPilot.Date(args.e.data.start); // clone gi√° tr·ªã
          const originalEnd = new DayPilot.Date(args.e.data.end); // clone gi√° tr·ªã
          const resizedEvent = {
            ...args.e.data,
            start: args.newStart,
            end: args.newEnd,
          };

          if (isOverlapping(resizedEvent)) {
            showAlert(
              "‚ö†Ô∏è Th·ªùi gian m·ªõi b·ªã tr√πng v·ªõi m·ªôt l·ªãch kh√°c!",
              "bg-red-600"
            );
            // Rollback v·ªÅ v·ªã tr√≠ c≈©
            args.preventDefault(); // NgƒÉn DayPilot c·∫≠p nh·∫≠t event
            return;
          }

          args.e.data.start = args.newStart;
          args.e.data.end = args.newEnd;
          dp.events.update(args.e);
          dp.update();
          showAlert("‚úèÔ∏è ƒê√£ thay ƒë·ªïi th·ªùi gian s·ª± ki·ªán", "bg-indigo-500");
        },
        onEventMoved: function (args) {
          const originalStart = args.e.data.start; // gi·ªØ nguy√™n g·ªëc, ƒë√£ ƒë√∫ng ƒë·ªãnh d·∫°ng
          const originalEnd = args.e.data.end;
          const movedEvent = {
            ...args.e.data,
            start: args.newStart,
            end: args.newEnd,
          };

          if (isOverlapping(movedEvent)) {
            showAlert(
              "‚ö†Ô∏è Th·ªùi gian m·ªõi b·ªã tr√πng v·ªõi m·ªôt l·ªãch kh√°c!",
              "bg-red-600"
            );

            // Rollback v·ªÅ v·ªã tr√≠ c≈©
            args.e.data.start = originalStart;
            args.e.data.end = originalEnd;
            dp.events.update(args.e);
            dp.update();
            return;
          }

          // N·∫øu kh√¥ng tr√πng th√¨ c·∫≠p nh·∫≠t nh∆∞ b√¨nh th∆∞·ªùng
          args.e.data.start = args.newStart;
          args.e.data.end = args.newEnd;
          dp.events.update(args.e);
          dp.update();
          showAlert("üîÑ C·∫≠p nh·∫≠t th·ªùi gian s·ª± ki·ªán th√†nh c√¥ng", "bg-blue-500");
        },
        onEventClick: function (args) {
          const e = args.e.data;
          const form = document.getElementById("bookingForm");
          form.room.value = e.resource;
          form.type.value = getRoomTypeById(e.resource); // override n·∫øu type ch∆∞a ƒë√∫ng
          form.start.value = new DayPilot.Date(e.start).toString(
            "dd/MM/yyyy HH:mm:ss"
          );
          form.end.value = new DayPilot.Date(e.end).toString(
            "dd/MM/yyyy HH:mm:ss"
          );
          form.guests.value = e.guests || "";
          form.name.value = e.name || "";
          form.phone.value = e.phone || "";
          form.email.value = e.email || "";
          form.note.value = e.note || "";
          form.dataset.eventId = e.id;
          document.getElementById("bookingModal").classList.remove("hidden");
        },
        onBeforeEventRender: function (args) {
          args.data.backColor =
            args.data.type === "VIP" ? "#ffc107" : "#3399ff";
          args.data.fontColor = "white";
          args.data.toolTip = `T√™n: ${args.data.name}
SƒêT: ${args.data.phone}
Kh√°ch: ${args.data.guests}`;
        },
      });

      dp.init();

      function openModal(args) {
        const form = document.getElementById("bookingForm");
        form.reset();
        form.room.value = args.resource;
        form.type.value = getRoomTypeById(args.resource);
        form.start.value = args.start.toString("dd/MM/yyyy HH:mm:ss");
        form.end.value = args.end.toString("dd/MM/yyyy HH:mm:ss");
        form.dataset.eventId = "";
        document.getElementById("bookingModal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("bookingModal").classList.add("hidden");
      }
      function isOverlapping(newEvent) {
        return dp.events.list.some((existing) => {
          // Kh√¥ng so s√°nh v·ªõi ch√≠nh n√≥ n·∫øu ƒëang update
          if (existing.id === newEvent.id) return false;

          // C√πng ph√≤ng?
          if (existing.resource !== newEvent.resource) return false;

          const start1 = new DayPilot.Date(existing.start);
          const end1 = new DayPilot.Date(existing.end);
          const start2 = new DayPilot.Date(newEvent.start);
          const end2 = new DayPilot.Date(newEvent.end);

          return !(end2 <= start1 || start2 >= end1); // C√≥ giao nhau
        });
      }
      document
        .getElementById("bookingForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const form = e.target;

          const requiredFields = [
            "room",
            "type",
            "start",
            "end",
            "guests",
            "name",
            "phone",
          ];

          for (const field of requiredFields) {
            const value = form[field].value.trim();
            if (!value) {
              showAlert(
                `‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß tr∆∞·ªùng: ${field}`,
                "bg-yellow-500"
              );
              form[field].focus();
              return;
            }
            if (field === "email") {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(value)) {
                showAlert("‚ö†Ô∏è Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng", "bg-yellow-500");
                form[field].focus();
                return;
              }
            }
            if (field === "phone") {
              const phoneRegex = /^0\d{9}$/;
              if (!phoneRegex.test(value)) {
                showAlert(
                  "‚ö†Ô∏è S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10 ch·ªØ s·ªë v√† b·∫Øt ƒë·∫ßu b·∫±ng 0",
                  "bg-yellow-500"
                );
                form[field].focus();
                return;
              }
            }
          }

          const parseDate = (str) => {
            const [date, time] = str.split(" ");
            const [day, month, year] = date.split("/");
            return `${year}-${month}-${day}T${time}`;
          };

          const eventId = form.dataset.eventId;
          const eObj = {
            id: eventId || DayPilot.guid(),
            start: parseDate(form.start.value),
            end: parseDate(form.end.value),
            resource: form.room.value,
            text: `${form.name.value} (${form.guests.value} kh√°ch)`,
            type: form.type.value,
            guests: form.guests.value,
            name: form.name.value,
            phone: form.phone.value,
            email: form.email.value,
            note: form.note.value,
          };
          if (isOverlapping(eObj)) {
            showAlert(
              "‚ö†Ô∏è Ph√≤ng n√†y ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t trong kho·∫£ng th·ªùi gian ƒë√≥!",
              "bg-red-600"
            );
            return;
          }

          if (eventId) {
            dp.events.update(eObj);
          } else {
            dp.events.add(eObj);
          }
          showAlert("‚úÖ L∆∞u th√¥ng tin ƒë·∫∑t ph√≤ng th√†nh c√¥ng", "bg-green-600");
          closeModal();
        });

      document.getElementById("datePicker").valueAsDate = new Date();
      document
        .getElementById("datePicker")
        .addEventListener("change", function (e) {
          dp.startDate = e.target.value;
          dp.update();
        });

      // Thay ƒë·ªïi ch·∫ø ƒë·ªô xem (ng√†y/tu·∫ßn/th√°ng)
      document
        .getElementById("viewMode")
        .addEventListener("change", function (e) {
          const mode = e.target.value;
          if (mode === "day") {
            dp.days = 1;
          } else if (mode === "week") {
            dp.days = 7;
          } else {
            dp.days = 30;
          }
          dp.update();
        });
      function getRoomTypeById(roomId) {
        const room = rooms.find((r) => r.id === roomId);
        return room ? room.type : "";
      }
      function showAlert(message, colorClass) {
        const box = document.getElementById("alertBox");
        box.textContent = message;
        box.className = `fixed top-4 right-4 px-4 py-2 rounded shadow text-white text-sm z-[9999] ${colorClass}`;
        box.classList.remove("hidden");
        setTimeout(() => box.classList.add("hidden"), 3000);
      }
      // Gi·∫£ l·∫≠p fetch lo·∫°i ph√≤ng t·ª´ API
      const roomTypesFromAPI = ["Standard", "Deluxe", "VIP"];
      const typeSelect = document.getElementById("roomTypeSelect");
      roomTypesFromAPI.forEach((type) => {
        const option = document.createElement("option");
        option.value = type;
        option.textContent = type;
        typeSelect.appendChild(option);
      });
    </script>
  </body>
</html>
